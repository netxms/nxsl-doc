---
kind: pipeline
type: docker
name: build-and-deploy

trigger:
  branch:
    - master
  event:
    - push

steps:
  - name: build
    image: ruby:3.3
    environment:
      CI: "true"
    commands:
      - bundle install
      - make html
      - make pdf

  - name: deploy
    image: alpine:3.23
    environment:
      SFTP_KEY:
        from_secret: sftp_key
      SFTP_HOST:
        from_secret: sftp_host
      SFTP_USER:
        from_secret: sftp_user
      SFTP_PORT:
        from_secret: sftp_port
    commands:
      - apk add --no-cache lftp openssh-client
      - mkdir -p ~/.ssh
      - printf '%s\n' "$SFTP_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - ssh-keyscan -p "$SFTP_PORT" "$SFTP_HOST" >> ~/.ssh/known_hosts 2>/dev/null
      - >-
        LFTP_PASSWORD=dummy lftp --env-password sftp://$SFTP_USER@$SFTP_HOST:$SFTP_PORT -e "
        put -O nxsl/ build/nxsl.html -o index.html;
        put -O nxsl/ build/nxsl.pdf;
        bye"

  - name: notify
    image: appleboy/drone-telegram
    settings:
      token:
        from_secret: telegram_bot_token
      to:
        from_secret: telegram_channel_id
      format: markdown
      disable_web_page_preview: true
      message: >
        {{#success build.status}}
        ✅ NXSL Docs [#{{build.number}}]({{build.link}}) succeeded.
        {{else}}
        ❌ NXSL Docs [#{{build.number}}]({{build.link}}) **FAILED**.
        `{{commit.message}}` by {{commit.author}}
        {{/success}}
    when:
      status:
        - success
        - failure
